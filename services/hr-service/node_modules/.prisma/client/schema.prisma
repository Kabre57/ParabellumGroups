generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Employe {
  id                    String        @id @default(uuid())
  matricule             String        @unique
  nom                   String
  prenom                String
  email                 String        @unique
  telephone             String?
  dateNaissance         DateTime?
  lieuNaissance         String?
  adresse               String?
  nationalite           String?
  cnpsNumber            String?
  cnamNumber            String?
  situationMatrimoniale String?
  nombreEnfants         Int?          @default(0)
  partsFiscales         Int           @default(1)
  dateEmbauche          DateTime
  poste                 String
  departement           String
  categorie             String?
  niveau                String?
  salaire               Decimal       @db.Decimal(12, 2)
  deviseSalaire         String        @default("XOF")
  status                StatusEmploye @default(ACTIF)
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  conges               Conge[]      @relation("EmployeConges")
  congesApprouves      Conge[]      @relation("ApprobateurConges")
  presences            Presence[]
  evaluations          Evaluation[] @relation("EmployeEvaluations")
  evaluationsRealisees Evaluation[] @relation("EvaluateurEvaluations")
  contrats             Contrat[]
  bulletins            Payroll[]

  @@map("employes")
}

enum StatusEmploye {
  ACTIF
  CONGE
  MALADIE
  DEMISSION
}

model Conge {
  id              String      @id @default(uuid())
  employeId       String
  typeConge       TypeConge
  dateDebut       DateTime
  dateFin         DateTime
  nbJours         Int
  motif           String?
  status          StatusConge @default(DEMANDE)
  approbateurId   String?
  dateApprobation DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  employe     Employe  @relation("EmployeConges", fields: [employeId], references: [id], onDelete: Cascade)
  approbateur Employe? @relation("ApprobateurConges", fields: [approbateurId], references: [id])

  @@map("conges")
}

enum TypeConge {
  ANNUEL
  MALADIE
  SANS_SOLDE
  PARENTAL
}

enum StatusConge {
  DEMANDE
  APPROUVE
  REJETE
  ANNULE
}

model Presence {
  id           String       @id @default(uuid())
  employeId    String
  date         DateTime
  heureArrivee DateTime?
  heureDepart  DateTime?
  duree        Decimal?     @db.Decimal(5, 2)
  type         TypePresence @default(BUREAU)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  employe Employe @relation(fields: [employeId], references: [id], onDelete: Cascade)

  @@unique([employeId, date])
  @@map("presences")
}

enum TypePresence {
  BUREAU
  TELETRAVAIL
  DEPLACEMENT
  ABSENCE
}

model Evaluation {
  id             String   @id @default(uuid())
  employeId      String
  evaluateurId   String
  dateEvaluation DateTime
  periode        String
  noteGlobale    Decimal  @db.Decimal(3, 2)
  competences    Json
  commentaires   String?
  objectifs      Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  employe    Employe @relation("EmployeEvaluations", fields: [employeId], references: [id], onDelete: Cascade)
  evaluateur Employe @relation("EvaluateurEvaluations", fields: [evaluateurId], references: [id])

  @@map("evaluations")
}

enum ContractType {
  CDI
  CDD
  STAGE
  INTERIM
  PRESTATION
}

enum ContractStatus {
  ACTIF
  TERMINE
  SUSPENDU
  RUPTURE
}

model Contrat {
  id                String         @id @default(uuid())
  employeId         String
  type              ContractType
  statut            ContractStatus @default(ACTIF)
  dateDebut         DateTime
  dateFin           DateTime?
  poste             String
  departement       String
  salaireBase       Decimal        @db.Decimal(12, 2)
  devise            String         @default("XOF")
  heuresHebdo       Int?
  cnpsTauxSalarie   Decimal?       @db.Decimal(5, 4)
  cnpsTauxEmployeur Decimal?       @db.Decimal(5, 4)
  cnamTauxEmployeur Decimal?       @db.Decimal(5, 4)
  cnpsAT            Decimal?       @db.Decimal(5, 4)
  riskBandId        String?
  autresAvantages   Json?
  clauses           Json?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  employe  Employe   @relation(fields: [employeId], references: [id], onDelete: Cascade)
  riskBand RiskBand? @relation(fields: [riskBandId], references: [id], onDelete: SetNull)

  @@index([employeId])
  @@index([riskBandId])
  @@map("contrats")
}

enum PayrollStatus {
  BROUILLON
  GENERE
  VALIDE
  PAYE
}

model Payroll {
  id                    String        @id @default(uuid())
  employeId             String
  mois                  Int
  annee                 Int
  periode               String?
  devise                String        @default("XOF")
  baseSalaire           Decimal       @db.Decimal(12, 2)
  heuresSup             Decimal       @default(0) @db.Decimal(12, 2)
  primes                Decimal       @default(0) @db.Decimal(12, 2)
  indemnite             Decimal       @default(0) @db.Decimal(12, 2)
  autresRetenues        Decimal       @default(0) @db.Decimal(12, 2)
  deductions            Json?
  partsFiscales         Int           @default(1)
  brut                  Decimal       @db.Decimal(12, 2)
  cnpsSalarial          Decimal       @db.Decimal(12, 2)
  cnpsPatronal          Decimal       @db.Decimal(12, 2)
  cnpsATUtilise         Decimal       @db.Decimal(12, 2)
  cnam                  Decimal       @db.Decimal(12, 2)
  fdfp                  Decimal       @db.Decimal(12, 2)
  igr                   Decimal       @db.Decimal(12, 2)
  cotisationsSalariales Decimal       @db.Decimal(12, 2)
  cotisationsPatronales Decimal       @db.Decimal(12, 2)
  netImposable          Decimal       @db.Decimal(12, 2)
  netAPayer             Decimal       @db.Decimal(12, 2)
  statut                PayrollStatus @default(GENERE)
  details               Json?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  employe Employe @relation(fields: [employeId], references: [id], onDelete: Cascade)

  @@index([employeId, annee, mois], name: "payroll_periode")
  @@map("payroll")
}

// --- Référentiels paie CI (paramétrables) ---

enum TaxSettingType {
  CNPS_RET_EMPLOYEE
  CNPS_RET_EMPLOYER
  CNPS_FAMILY
  CNPS_AT
  CNAM_EMPLOYER
  FDFP_EMPLOYER
  IS_EMPLOYER
  AS_EMPLOYER
}

model TaxSetting {
  id        String         @id @default(uuid())
  code      String         @unique
  label     String
  type      TaxSettingType
  rate      Decimal        @db.Decimal(10, 4)
  ceiling   Decimal?       @db.Decimal(12, 2)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@map("tax_settings")
}

model PayrollConstant {
  id          String   @id @default(uuid())
  key         String   @unique
  value       Decimal  @db.Decimal(14, 4)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("payroll_constants")
}

model RiskBand {
  id          String   @id @default(uuid())
  code        String   @unique
  label       String
  rate        Decimal  @db.Decimal(10, 4) // ex: 0.0200 = 2%
  departement String?
  secteur     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  contrats Contrat[]

  @@map("risk_bands")
}

model IgrBracket {
  id        String   @id @default(uuid())
  min       Decimal  @db.Decimal(14, 2)
  max       Decimal? @db.Decimal(14, 2) // null => pas de plafond
  rate      Decimal  @db.Decimal(10, 4) // 0.35 = 35%
  deduction Decimal  @default(0) @db.Decimal(14, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("igr_brackets")
}
