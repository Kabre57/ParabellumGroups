// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================
enum StatusClient {
  PROSPECT
  ACTIF
  INACTIF
  SUSPENDU
  ARCHIVE
  LEAD_CHAUD
  LEAD_FROID
}

enum PrioriteClient {
  BASSE
  MOYENNE
  HAUTE
  CRITIQUE
}

enum StatutContact {
  ACTIF
  INACTIF
  PARTI
}

enum TypeContact {
  COMMERCIAL
  TECHNIQUE
  COMPTABLE
  DIRECTION
  SUPPORT
  AUTRE
}

enum StatusContrat {
  BROUILLON
  EN_ATTENTE_SIGNATURE
  ACTIF
  SUSPENDU
  RESILIE
  TERMINE
  EN_RENOUVELLEMENT
}

enum TypeContrat {
  MAINTENANCE
  SERVICE
  PRODUIT
  PARTENARIAT
  ABONNEMENT
  FORFAIT
  CONSULTING
  FORMATION
  LICENCE
  SAAS
}

enum TypeDocument {
  CONTRAT
  FACTURE
  DEVIS
  AVENANT
  KYC
  LEGAL
  TECHNIQUE
  COMMERCIAL
  ADMINISTRATIF
  FINANCIER
  RAPPORT
}

enum TypeInteraction {
  APPEL
  EMAIL
  REUNION
  VISITE
  SUPPORT
  COMMERCIAL
  TECHNIQUE
  FORMATION
  DEMONSTRATION
  PRESENTATION
  NEGOCIATION
}

enum CanalInteraction {
  TELEPHONE
  EMAIL
  EN_PERSONNE
  VIDEO
  CHAT
  RESEAUX_SOCIAUX
  PORTAL_CLIENT
  MOBILE
}

enum StatutTache {
  A_FAIRE
  EN_COURS
  TERMINEE
  ANNULEE
  REPORTEE
}

enum PrioriteTache {
  BASSE
  NORMALE
  ELEVEE
  URGENTE
}

enum TypeAdresse {
  FACTURATION
  LIVRAISON
  SIEGE_SOCIAL
  ETABLISSEMENT
  CORRESPONDANCE
}

enum SourceClient {
  PROSPECTION
  RECOMMANDATION
  PARTENAIRE
  SALON
  SITE_WEB
  RESEAUX_SOCIAUX
  CAMPAGNE_EMAIL
  APPEL_ENTRANT
  BASE_ACHETEE
  AUTRE
}

// ==================== TABLES PRINCIPALES ====================

// Table des types de clients (remplace l'enum)
model TypeClient {
  id            String      @id @default(uuid())
  code          String      @unique
  libelle       String
  description   String?
  couleur       String?     @default("#3B82F6")
  icone         String?
  ordre         Int         @default(0)
  isActive      Boolean     @default(true)
  
  // Relations
  clients       Client[]
  
  // Métadonnées
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  createdBy     String?
  updatedBy     String?
  
  @@map("type_clients")
  @@index([code])
  @@index([isActive])
}

// Table des secteurs d'activité
model SecteurActivite {
  id            String          @id @default(uuid())
  codeNAF       String?         @unique
  libelle       String
  description   String?
  parentId      String?
  niveau        Int             @default(1)
  
  // Relations hiérarchiques
  parent        SecteurActivite? @relation("SecteurHierarchie", fields: [parentId], references: [id])
  enfants       SecteurActivite[] @relation("SecteurHierarchie")
  
  // Relations
  clients       Client[]
  
  // Métadonnées
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  @@map("secteurs_activite")
  @@index([parentId])
  @@index([codeNAF])
}

// Table principale des clients
model Client {
  // ===== IDENTIFIANT =====
  id            String          @id @default(uuid())
  
  // ===== INFORMATIONS GENERALES =====
  reference     String          @unique
  nom           String
  raisonSociale String?         // Pour les entreprises
  siret         String?         @unique
  tvaIntra      String?         @unique
  ape           String?
  
  // ===== CLASSIFICATION =====
  typeClientId  String
  secteurActiviteId String?
  status        StatusClient    @default(PROSPECT)
  priorite      PrioriteClient  @default(MOYENNE)
  source        SourceClient?
  
  // ===== CONTACT PRINCIPAL =====
  email         String          @unique
  telephone     String?
  mobile        String?
  fax           String?
  siteWeb       String?
  
  // ===== INFORMATIONS COMMERCIALES =====
  chiffreAffaireAnnuel Decimal? @db.Decimal(15, 2)
  effectif      Int?
  dateCreationEntreprise DateTime?
  
  // ===== SCORING =====
  scoreFidelite Int             @default(0)
  scoreRisque   Int             @default(50)
  noteInterne   Int?            @default(3) // 1-5
  
  // ===== DATES IMPORTANTES =====
  datePremierContact DateTime?
  dateDerniereInteraction DateTime?
  dateDevenirClient DateTime?
  dateDerniereVisite DateTime?
  
  // ===== INTEGRATION COMMERCIALE =====
  prospectId    String?         @unique
  commercialId  String?         // Référent commercial principal
  convertedAt   DateTime?
  
  // ===== RELATIONS =====
  typeClient    TypeClient      @relation(fields: [typeClientId], references: [id])
  secteurActivite SecteurActivite? @relation(fields: [secteurActiviteId], references: [id])
  contacts      Contact[]
  contrats      Contrat[]
  adresses      AdresseClient[]
  interactions  InteractionClient[]
  documents     DocumentClient[]
  notes         NoteClient[]
  taches        TacheClient[]
  tags          TagClient[]
  opportunites  Opportunite[]
  historique    HistoriqueClient[]
  preferences   PreferenceClient?
  abonnements   AbonnementClient[]
  factures      Facture[]
  synchronisations SynchronisationProspectClient[]
  
  // ===== METADONNEES =====
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  createdBy     String?
  updatedBy     String?
  version       Int             @default(1)
  
  @@map("clients")
  @@index([typeClientId])
  @@index([secteurActiviteId])
  @@index([status])
  @@index([priorite])
  @@index([commercialId])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([reference])
}

// Table des contacts
model Contact {
  id            String        @id @default(uuid())
  clientId      String
  civilite      String?       // M., Mme, Mlle
  nom           String
  prenom        String
  email         String?
  emailSecondaire String?
  telephone     String?
  mobile        String?
  poste         String?
  departement   String?
  type          TypeContact   @default(COMMERCIAL)
  statut        StatutContact @default(ACTIF)
  principal     Boolean       @default(false)
  dateNaissance DateTime?
  
  // Relations
  client        Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  interactions  InteractionClient[]
  notesRel      NoteClient[]  // Renommé pour éviter le conflit
  tachesRel     TacheClient[] // Renommé pour éviter le conflit
  
  // Métadonnées
  notes         String?
  preferencesContact Json?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@map("contacts")
  @@unique([clientId, email])
  @@index([clientId])
  @@index([principal])
  @@index([type])
  @@index([statut])
}

// Table des adresses
model AdresseClient {
  id            String        @id @default(uuid())
  clientId      String
  typeAdresse   TypeAdresse   @default(FACTURATION)
  nomAdresse    String?       // "Siège social", "Usine", etc.
  ligne1        String
  ligne2        String?
  ligne3        String?
  codePostal    String
  ville         String
  region        String?
  pays          String        @default("cote d\'ivoire")
  isPrincipal   Boolean       @default(false)
  coordonneesGps String?      // "lat,lng"
  informationsAcces String?
  
  // Relations
  client        Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  // Métadonnées
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@map("adresse_clients")
  @@index([clientId])
  @@index([typeAdresse])
  @@index([isPrincipal])
  @@unique([clientId, typeAdresse])
}

// Table des contrats
model Contrat {
  id              String          @id @default(uuid())
  clientId        String
  reference       String          @unique
  numeroContrat   String?
  titre           String
  description     String?
  typeContrat     TypeContrat
  
  // Dates
  dateDebut       DateTime
  dateFin         DateTime?
  dateSignature   DateTime?
  dateEffet       DateTime?
  
  // Financier
  montantHT       Decimal         @db.Decimal(12, 2)
  montantTTC      Decimal         @db.Decimal(12, 2)
  devise          String          @default("EUR")
  tauxTVA         Decimal         @db.Decimal(5, 2) @default(20.00)
  periodicitePaiement String?     // "MENSUEL", "TRIMESTRIEL", "ANNUEL"
  jourPaiement    Int?            // Jour du mois (1-31)
  
  // Statut
  status          StatusContrat   @default(BROUILLON)
  motifSuspension String?
  motifResiliation String?
  
  // Renouvellement
  estRenouvelable Boolean         @default(false)
  periodeRenouvellement String?   // "1M", "3M", "1Y", etc.
  dateProchainRenouvellement DateTime?
  preavisRenouvellement Int?      // En jours
  
  // Documents
  documentContratId String?       // Référence au document stocké
  conditionsParticulieres String?
  
  // Relations
  client          Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  avenants        AvenantContrat[]
  factures        Facture[]
  documentsRel    DocumentClient[]
  
  // Métadonnées
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  createdBy       String?
  signataireId    String?         // ID du contact signataire
  
  @@map("contrats")
  @@index([clientId])
  @@index([status])
  @@index([dateFin])
  @@index([typeContrat])
  @@index([dateProchainRenouvellement])
}

// Table des avenants de contrat
model AvenantContrat {
  id              String          @id @default(uuid())
  contratId       String
  numeroAvenant   String
  description     String
  modifications   Json            // Détail des modifications
  dateEffet       DateTime
  dateSignature   DateTime?
  montantAdditionnel Decimal?     @db.Decimal(12, 2)
  
  // Relations
  contrat         Contrat         @relation(fields: [contratId], references: [id], onDelete: Cascade)
  
  // Métadonnées
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  createdBy       String?
  
  @@map("avenants_contrat")
  @@unique([contratId, numeroAvenant])
  @@index([contratId])
}

// Table des interactions
model InteractionClient {
  id            String            @id @default(uuid())
  clientId      String
  contactId     String?           // Contact spécifique
  type          TypeInteraction
  canal         CanalInteraction
  sujet         String
  description   String?
  dateInteraction DateTime        @default(now())
  dateSuivie    DateTime?
  dureeMinutes  Int?
  resultat      String?           // "POSITIF", "NEUTRE", "NEGATIF"
  actionRequise String?           // Prochaine action
  tacheLieeId   String?           @unique // Changé à unique pour relation 1:1
  
  // Relations
  client        Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  contact       Contact?          @relation(fields: [contactId], references: [id])
  tacheLiee     TacheClient?      @relation("InteractionTache", fields: [tacheLieeId], references: [id])
  
  // Métadonnées
  createdById   String
  participants  String[]          // IDs des participants
  tags          String[]
  piecesJointes String[]          // URLs ou chemins des fichiers
  confidential  Boolean           @default(false)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  
  @@map("interaction_clients")
  @@index([clientId])
  @@index([contactId])
  @@index([dateInteraction])
  @@index([type])
  @@index([createdById])
}

// Table des documents
model DocumentClient {
  id            String          @id @default(uuid())
  clientId      String
  contratId     String?
  typeDocument  TypeDocument
  categorie     String?         // Sous-catégorie
  nomFichier    String
  chemin        String          // URL ou chemin du stockage
  taille        Int             // En octets
  mimeType      String
  description   String?
  motsCles      String[]
  version       String          @default("1.0")
  estValide     Boolean         @default(true)
  dateExpiration DateTime?
  
  // Relations
  client        Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  contrat       Contrat?        @relation(fields: [contratId], references: [id])
  
  // Métadonnées
  uploadedById  String
  dateUpload    DateTime        @default(now())
  dateModification DateTime?
  signatureDigitale String?     // Hash ou signature
  confidential  Boolean         @default(false)
  
  @@map("document_clients")
  @@index([clientId])
  @@index([contratId])
  @@index([typeDocument])
  @@index([dateUpload])
  @@index([estValide])
}

// Table des notes internes
model NoteClient {
  id            String        @id @default(uuid())
  clientId      String
  contactId     String?
  titre         String
  contenu       String
  typeNote      String        @default("INTERNE") // "INTERNE", "APPEL", "VISITE", etc.
  estPrivee     Boolean       @default(true)
  priorite      PrioriteTache @default(NORMALE)
  
  // Relations
  client        Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  contact       Contact?      @relation(fields: [contactId], references: [id])
  
  // Métadonnées
  createdById   String
  tags          String[]
  rappelLe      DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@map("note_clients")
  @@index([clientId])
  @@index([contactId])
  @@index([createdAt])
  @@index([estPrivee])
  @@index([rappelLe])
}

// Table des tâches
model TacheClient {
  id            String        @id @default(uuid())
  clientId      String
  contactId     String?
  titre         String
  description   String?
  statut        StatutTache   @default(A_FAIRE)
  priorite      PrioriteTache @default(NORMALE)
  categorie     String?       // "COMMERCIAL", "SUPPORT", "ADMIN", etc.
  
  // Dates
  dateEcheance  DateTime?
  dateDebut     DateTime?
  dateFin       DateTime?
  
  // Assignation
  assigneA      String?       // ID utilisateur assigné
  createurId    String
  
  // Relations
  client        Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  contact       Contact?      @relation(fields: [contactId], references: [id])
  interaction   InteractionClient? @relation("InteractionTache")
  
  // Métadonnées
  progression   Int           @default(0) // 0-100
  tags          String[]
  estRecurrente Boolean       @default(false)
  recurrence    String?       // "QUOTIDIEN", "HEBDOMADAIRE", etc.
  parentTaskId  String?       // Pour les sous-tâches
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@map("tache_clients")
  @@index([clientId])
  @@index([contactId])
  @@index([statut])
  @@index([priorite])
  @@index([dateEcheance])
  @@index([assigneA])
}

// Table des opportunités
model Opportunite {
  id              String          @id @default(uuid())
  clientId        String
  nom             String
  description     String?
  montantEstime   Decimal         @db.Decimal(12, 2)
  probabilite     Int             @default(50) // 0-100
  dateFermetureEstimee DateTime?
  etape           String          @default("PROSPECTION") // "PROSPECTION", "QUALIFICATION", etc.
  statut          String          @default("OUVERTE") // "OUVERTE", "GAGNEE", "PERDUE"
  raisonPerdue    String?
  
  // Relations
  client          Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  produits        LigneProduit[]
  
  // Métadonnées
  createdById     String
  commercialId    String?
  source          String?
  tags            String[]
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@map("opportunites")
  @@index([clientId])
  @@index([etape])
  @@index([statut])
  @@index([dateFermetureEstimee])
  @@index([commercialId])
}

// Table des lignes de produit dans les opportunités
model LigneProduit {
  id            String          @id @default(uuid())
  opportuniteId String
  produitId     String?         // Référence au catalogue produits
  description   String
  quantite      Int             @default(1)
  prixUnitaire  Decimal         @db.Decimal(10, 2)
  remise        Decimal?        @db.Decimal(5, 2)
  tva           Decimal         @db.Decimal(5, 2) @default(20.00)
  
  // Relations
  opportunite   Opportunite     @relation(fields: [opportuniteId], references: [id], onDelete: Cascade)
  
  // Calculé
  montantHT     Decimal         @db.Decimal(12, 2)
  montantTTC    Decimal         @db.Decimal(12, 2)
  
  @@map("lignes_produit")
  @@index([opportuniteId])
}

// Table des factures
model Facture {
  id            String          @id @default(uuid())
  clientId      String
  contratId     String?
  numeroFacture String          @unique
  typeFacture   String          @default("STANDARD") // "ACOMPTE", "SOLDE", "AVOIR"
  dateEmission  DateTime        @default(now())
  dateEcheance  DateTime?
  datePaiement  DateTime?
  
  // Montants
  montantHT     Decimal         @db.Decimal(12, 2)
  montantTVA    Decimal         @db.Decimal(12, 2)
  montantTTC    Decimal         @db.Decimal(12, 2)
  montantPaye   Decimal         @db.Decimal(12, 2) @default(0)
  solde         Decimal         @db.Decimal(12, 2) // Calculé: TTC - Payé
  
  // Statut
  statut        String          @default("EMISE") // "EMISE", "ENVOYEE", "PAYEE", "EN_RETARD", "ANNULEE"
  modePaiement  String?         // "VIREMENT", "CARTE", "CHEQUE", etc.
  referencePaiement String?
  
  // Relations
  client        Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  contrat       Contrat?        @relation(fields: [contratId], references: [id])
  lignes        LigneFacture[]
  
  // Métadonnées
  notes         String?
  conditionsPaiement String?
  penalitesRetard String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  @@map("factures")
  @@index([clientId])
  @@index([contratId])
  @@index([dateEmission])
  @@index([statut])
  @@index([dateEcheance])
}

// Table des lignes de facture
model LigneFacture {
  id            String          @id @default(uuid())
  factureId     String
  description   String
  quantite      Decimal         @db.Decimal(10, 3) @default(1)
  prixUnitaire  Decimal         @db.Decimal(10, 2)
  tauxTVA       Decimal         @db.Decimal(5, 2) @default(20.00)
  remise        Decimal?        @db.Decimal(5, 2)
  
  // Calculés
  montantHT     Decimal         @db.Decimal(12, 2)
  montantTVA    Decimal         @db.Decimal(12, 2)
  montantTTC    Decimal         @db.Decimal(12, 2)
  
  // Relations
  facture       Facture         @relation(fields: [factureId], references: [id], onDelete: Cascade)
  
  @@map("lignes_facture")
  @@index([factureId])
}

// Table des préférences clients
model PreferenceClient {
  id            String          @id @default(uuid())
  clientId      String          @unique
  langue        String          @default("fr")
  fuseauHoraire String          @default("Europe/Paris")
  formatDate    String          @default("DD/MM/YYYY")
  devise        String          @default("EUR")
  
  // Communications
  accepteMarketing Boolean      @default(false)
  accepteNewsletter Boolean     @default(false)
  modeCommunicationPrefere String? // "EMAIL", "TELEPHONE", "SMS", etc.
  horairesContact  Json?        // Plages horaires préférées
  
  // RGPD
  rgpdAccepteLe DateTime?
  rgpdMiseAJourLe DateTime?
  donneesSupprimeesLe DateTime?
  categoriesDonneesConsenties String[]
  
  // Relations
  client        Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  // Métadonnées
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  @@map("preferences_clients")
}

// Table des tags clients
model TagClient {
  id            String          @id @default(uuid())
  clientId      String
  tag           String
  categorie     String?         // "SECTEUR", "COMPORTEMENT", "STATUT", etc.
  couleur       String?
  
  // Relations
  client        Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  @@map("tag_clients")
  @@unique([clientId, tag])
  @@index([clientId])
  @@index([tag])
  @@index([categorie])
}

// Table des abonnements clients
model AbonnementClient {
  id            String          @id @default(uuid())
  clientId      String
  serviceId     String          // Référence au service
  nomService    String
  dateDebut     DateTime
  dateFin       DateTime?
  statut        String          @default("ACTIF") // "ACTIF", "SUSPENDU", "RESILIE"
  periodicite   String          // "MENSUEL", "ANNUEL", etc.
  montant       Decimal         @db.Decimal(10, 2)
  dateProchainPaiement DateTime?
  
  // Relations
  client        Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  // Métadonnées
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  @@map("abonnement_clients")
  @@index([clientId])
  @@index([statut])
  @@index([dateProchainPaiement])
}

// Table d'historique des modifications
model HistoriqueClient {
  id            String          @id @default(uuid())
  clientId      String
  typeChangement String         // "CREATION", "MODIFICATION", "SUPPRESSION", "STATUT"
  entite        String         // "CLIENT", "CONTRAT", "CONTACT", etc.
  entiteId      String?
  ancienneValeur Json?
  nouvelleValeur Json?
  differences   Json?          // Diff entre ancienne et nouvelle
  
  // Métadonnées
  modifieParId  String
  modifieLe     DateTime        @default(now())
  ipAddress     String?
  userAgent     String?
  
  // Relations
  client        Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  @@map("historique_clients")
  @@index([clientId])
  @@index([modifieLe])
  @@index([entite, entiteId])
}

// Table de synchronisation avec le service commercial
model SynchronisationProspectClient {
  id            String          @id @default(uuid())
  prospectId    String
  clientId      String
  typeSync      String          @default("PROSPECT_TO_CLIENT")
  dateSynchronisation DateTime  @default(now())
  status        String          @default("SUCCES") // "SUCCES", "ECHEC", "EN_COURS"
  erreur        String?
  details       Json?
  tentatives    Int             @default(1)
  
  // Relations
  client        Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  // Métadonnées
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  @@map("sync_prospect_client")
  @@unique([prospectId, clientId])
  @@index([dateSynchronisation])
  @@index([status])
}

// Table de mapping des statuts entre services
model MappingStatus {
  id            String          @id @default(uuid())
  serviceSource String          // "COMMERCIAL", "CRM"
  statusSource  String
  serviceCible  String
  statusCible   String
  priorite      Int             @default(0)
  actif         Boolean         @default(true)
  
  @@unique([serviceSource, statusSource, serviceCible])
  @@map("mapping_status")
  @@index([serviceSource, serviceCible])
}